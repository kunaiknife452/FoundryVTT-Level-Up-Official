<script>
    import { localize } from "#runtime/svelte/helper";
    import { getContext } from "svelte";

    import RollTooltip from "../tooltips/RollTooltip.svelte";
    import DamageButtons from "./DamageButtons.svelte";

    import getExpertiseDieSize from "../../../utils/getExpertiseDieSize";
    import RollConfigurationOptions from "./RollConfigurationOptions.svelte";
    import ChatCard from "../ChatCard.svelte";

    export let roll;
    export let rollData = {};
    export let isAction = true;

    function determineIfCriticalFailure(roll) {
        const d20Roll = roll.terms.find((term) => term.faces === 20);

        if (!d20Roll) return false;

        return d20Roll.results.some(
            ({ result, active }) => active && result === 1,
        );
    }

    function determineIfCriticalSuccess(roll) {
        const d20Roll = roll.terms.find((term) => term.faces === 20);

        if (!d20Roll) return false;

        return d20Roll.results.some(
            ({ result, active }) =>
                active && result >= (rollData.critThreshold ?? 20),
        );
    }

    function getRollModeLabel({ rollMode }) {
        if (!rollMode) return null;

      return localize(
          rollMode === 1 ? "A5E.RollModeAdvantage" :
          (rollMode === 2 ? "A5E.RollModePassive" : "A5E.RollModeDisadvantage")
      );
    }

    function getExpertiseLabel({ expertiseDice }) {
        if (!expertiseDice) return null;

        return localize("A5E.ExpertiseDieSpecific", {
            dieSize: getExpertiseDieSize(expertiseDice),
        });
    }

    async function rollOnSkillTable(skillKey, resultType) {
        const tableKey =
            resultType === "critical"
                ? "skillCriticalTables"
                : "skillFumbleTables";

        const critTableUUID = CONFIG.A5E[tableKey]?.[skillKey];
        const critTable = await fromUuid(critTableUUID);

        if (!critTable) return;

        const rollOutcome = await critTable.roll();
        const result = rollOutcome?.results?.[0];

        const chatData = {
            user: game.user?.id,
            speaker: ChatMessage.getSpeaker({ actor }),
            flags: {
                a5e: {
                    actorId: actor.uuid,
                    cardType: "rollTableOutput",
                    itemDescription: result?.text,
                    img: critTable?.img,
                    name: critTable?.name,
                    actionName: result?.flags?.title,
                },
            },
            content: "<article></article>",
        };

        // critTable.toMessage(rollOutcome.results, { roll: rollOutcome.roll });
        ChatMessage.applyRollMode(
            chatData,
            game.settings.get("core", "rollMode"),
        );

        return ChatMessage.create(chatData);
    }

    async function toggleRollConfig() {
        showRollConfig = !showRollConfig;

        if (showRollConfig) {
            const messages = [...(game.messages ?? [])];
            const lastMessage = messages[messages.length - 1];

            if ($message.id === lastMessage?.id) {
                setTimeout(() => ui.chat.scrollBottom(), 0);
            }
        }
    }

    async function toggleRollTooltip() {
        tooltipIsVisible = !tooltipIsVisible;

        if (tooltipIsVisible) {
            const messages = [...(game.messages ?? [])];
            const lastMessage = messages[messages.length - 1];

            if ($message.id === lastMessage?.id) {
                setTimeout(() => ui.chat.scrollBottom(), 0);
            }
        }
    }

    let tooltipIsVisible = false;
    let showRollConfig = false;

    const message = getContext("message");
    const actor = fromUuidSync($message?.flags?.a5e?.actorId);

    $: isCriticalFailure = determineIfCriticalFailure(roll);
    $: isCriticalSuccess = determineIfCriticalSuccess(roll);
</script>

<button class="roll-container" on:click={toggleRollTooltip}>
    <div
        class="roll"
        class:roll--max={isCriticalSuccess}
        class:roll--min={isCriticalFailure}
        class:roll--wide={!isAction}
    >
        {roll.total}
    </div>

    <header class="roll-header">
        <h3 class="roll-label">
            {rollData.label}
        </h3>

        {#if !showRollConfig && (rollData.expertiseDice || rollData.rollMode || rollData.userLabel)}
            <div class="subtitle-wrapper">
                {#if rollData.rollMode}
                    <span
                        class="roll-mode"
                        class:roll-mode--disadvantage={rollData.rollMode === -1}
                    >
                        {getRollModeLabel(rollData)}
                    </span>
                {/if}

                {#if rollData.expertiseDice}
                    <span class="expertise-label">
                        {getExpertiseLabel(rollData)}
                    </span>
                {/if}

                {#if rollData.userLabel}
                    <span class="roll-sublabel">{rollData.userLabel}</span>
                {/if}
            </div>
        {/if}
    </header>

    <!-- svelte-ignore missing-declaration -->
    {#if rollData.type === "damage" || rollData.type === "healing"}
        <DamageButtons {roll} {rollData} />
    {:else if (game.user.isGM || actor?.testUserPermission(game.user, 2)) && ["abilityCheck", "attack", "savingThrow", "skillCheck", "toolCheck"].includes(rollData.type)}
        <button
            class="roll-mode-button fa-dice fa-solid"
            on:click|stopPropagation={toggleRollConfig}
            data-tooltip={"Modify Roll"}
            data-tooltip-direction="LEFT"
        />
    {/if}
</button>

{#if rollData.type === "skillCheck" && rollData.skillKey}
    {#if isCriticalSuccess}
        <button
            on:click={() => rollOnSkillTable(rollData.skillKey, "critical")}
        >
            <i class="fa-solid fa-dice-d20"></i>
            Roll on the skill critical success table
        </button>
    {/if}

    {#if isCriticalFailure}
        <button on:click={() => rollOnSkillTable(rollData.skillKey, "fumble")}>
            <i class="fa-solid fa-dice-d20"></i>
            Roll on the skill critical failure table
        </button>
    {/if}
{/if}

{#if showRollConfig}
    <RollConfigurationOptions
        {rollData}
        on:toggleRollMode
        on:toggleExpertiseDice
    />
{/if}

{#if tooltipIsVisible}
    <RollTooltip
        critThreshold={rollData.critThreshold}
        {roll}
        on:toggleTooltipVisibility={() =>
            (tooltipIsVisible = !tooltipIsVisible)}
    />
{/if}

<style lang="scss">
    .roll {
        display: flex;
        flex-grow: 0;
        align-items: center;
        justify-content: center;
        height: 2.25rem;
        width: 2.5rem;
        font-size: var(--a5e-text-size-lg);
        font-weight: 700;
        background: rgba(0, 0, 0, 0.05);
        border: 1px solid #ccc;
        border-radius: $border-radius-standard;

        &--max {
            color: #18520b;
            background-color: #c7d0c0;
            border: 1px solid #97ae8f;
        }

        &--min {
            color: #aa0200;
            background-color: #ffdddd;
            border: 1px solid #f0b5b5;
        }

        &--wide {
            width: 100%;
            height: 2rem;
        }
    }

    .roll-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0;
        padding: 0;
        background: transparent;
        border: 0;
        box-shadow: none;

        &:hover {
            box-shadow: none;
        }
    }

    .roll-header {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        text-align: left;
    }

    .roll-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0;
        font-size: var(--a5e-text-size-sm);
        line-height: 1;
        font-weight: bold;
        border: 0;
    }

    .roll-mode-button {
        width: fit-content;
        margin: 0;
        margin-left: auto;
        padding: 0.25rem 0.375rem;
        font-size: var(--a5e-text-size-sm);
        line-height: 1;
        color: #7e7960;
        background: rgba(0, 0, 0, 0.05);
        border: 1px solid #ccc;
        border-radius: $border-radius-standard;

        transition: $standard-transition;

        &:hover,
        &:focus {
            color: $color-dark-text;
            box-shadow: none;
        }
    }

    .expertise-label,
    .roll-mode {
        display: block;
        flex-shrink: 0;
        width: fit-content;
        padding: 0.075rem 0.3rem;
        font-size: var(--a5e-text-size-xs);
        line-height: 1;
        color: white;
        background: $color-primary;
        border: 1px solid $color-primary;
        border-radius: $border-radius-standard;
    }

    .roll-mode--disadvantage {
        border-color: #772020;
        background: $color-secondary;
    }

    .roll-sublabel {
        width: 100%;
        font-size: var(--a5e-text-size-xs);
        line-height: 1;
        color: #7e7960;
    }

    .subtitle-wrapper {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
</style>
